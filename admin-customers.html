<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÎçîÏõêÏ£ºÌÉùÍ¥ÄÎ¶¨ - Í≥†Í∞ùÍ¥ÄÎ¶¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans KR', Arial, sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 24px;
        }
        
        .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .search-group {
            display: flex;
            gap: 10px;
            flex: 1;
            min-width: 300px;
        }
        
        .search-group input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e1e8ed;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .search-btn, .add-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }
        
        .search-btn {
            background: #667eea;
            color: white;
        }
        
        .add-btn {
            background: #27ae60;
            color: white;
        }
        
        .search-btn:hover, .add-btn:hover {
            opacity: 0.9;
        }
        
        .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        
        .table-header {
            background: #34495e;
            color: white;
            padding: 20px;
            font-size: 18px;
            font-weight: 600;
        }
        
        .customers-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .customers-table th,
        .customers-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .customers-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .customers-table tr:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-active {
            background: #d5f4e6;
            color: #27ae60;
        }
        
        .status-inactive {
            background: #fab1a0;
            color: #e74c3c;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .edit-btn {
            background: #f39c12;
            color: white;
        }
        
        .delete-btn {
            background: #e74c3c;
            color: white;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 0;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            background: #34495e;
            color: white;
            padding: 20px;
            font-size: 18px;
            font-weight: 600;
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .building-input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .building-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .toggle-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .toggle-btn.active {
            background: #667eea;
            color: white;
        }
        
        .new-building-section {
            display: none;
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            margin-top: 10px;
        }
        
        .new-building-section h5 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .building-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #ecf0f1;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .cancel-btn, .save-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .cancel-btn {
            background: #95a5a6;
            color: white;
        }
        
        .save-btn {
            background: #27ae60;
            color: white;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            padding: 0 10px;
        }
        
        .close:hover {
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .success-message {
            background: #d5f4e6;
            color: #27ae60;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #27ae60;
        }
        
        .error-message {
            background: #fdf2f2;
            color: #e74c3c;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #e74c3c;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 5px;
        }
        
        .page-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 3px;
        }
        
        .page-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-group {
                min-width: auto;
            }
            
            .customers-table {
                font-size: 12px;
            }
            
            .customers-table th,
            .customers-table td {
                padding: 10px 5px;
            }
            
            .building-form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
    
    <!-- Google Apps Script Web App URL for CRUD operations -->
    <script>
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec';
    </script>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>üë• Í≥†Í∞ùÍ¥ÄÎ¶¨ 1.0.1 </h1>
            <a href="admin.html" class="back-btn">‚Üê ÎåÄÏãúÎ≥¥ÎìúÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞</a>
        </div>
    </div>
    
    <div class="container">
        <div id="messageContainer"></div>
        
        <div class="controls">
            <div class="search-group">
                <input type="text" id="searchInput" placeholder="Í≥†Í∞ùÎ™Ö, Í±¥Î¨ºÎ™Ö, Ï†ÑÌôîÎ≤àÌò∏Î°ú Í≤ÄÏÉâ...">
                <button class="search-btn" onclick="searchCustomers()">üîç Í≤ÄÏÉâ</button>
            </div>
            <button class="add-btn" onclick="openModal('add')">‚ûï Ïã†Í∑ú Í≥†Í∞ù Ï∂îÍ∞Ä</button>
        </div>
        
        <div class="table-container">
            <div class="table-header">
                Í≥†Í∞ù Î™©Î°ù (<span id="customerCount">0</span>Î™Ö)
            </div>
            <div id="tableContent">
                <div class="loading">Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
            </div>
        </div>
        
        <div id="pagination" class="pagination"></div>
    </div>
    
    <!-- Í≥†Í∞ù Ï∂îÍ∞Ä/ÏàòÏ†ï Î™®Îã¨ -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="modalTitle">Ïã†Í∑ú Í≥†Í∞ù Ï∂îÍ∞Ä</span>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="customerForm">
                    <input type="hidden" id="customerId" name="customerId">
                    
                    <div class="form-group">
                        <label for="customerName">Í≥†Í∞ùÎ™Ö *</label>
                        <input type="text" id="customerName" name="customerName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="customerPhone">Ï†ÑÌôîÎ≤àÌò∏ *</label>
                        <input type="tel" id="customerPhone" name="customerPhone" placeholder="010-1234-5678" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Í±¥Î¨º ÏÑ†ÌÉù *</label>
                        <div class="building-input-group">
                            <div class="building-toggle">
                                <button type="button" class="toggle-btn active" id="existingBuildingBtn" onclick="toggleBuildingMode('existing')">
                                    Í∏∞Ï°¥ Í±¥Î¨º ÏÑ†ÌÉù
                                </button>
                                <button type="button" class="toggle-btn" id="newBuildingBtn" onclick="toggleBuildingMode('new')">
                                    Ïã†Í∑ú Í±¥Î¨º Îì±Î°ù
                                </button>
                            </div>
                            
                            <div id="existingBuildingSection">
                                <select id="buildingName" name="buildingName">
                                    <option value="">Í±¥Î¨ºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                                </select>
                            </div>
                            
                            <div id="newBuildingSection" class="new-building-section">
                                <h5>üè¢ Ïã†Í∑ú Í±¥Î¨º Ï†ïÎ≥¥</h5>
                                <div class="building-form-row">
                                    <div class="form-group">
                                        <label for="newBuildingName">Í±¥Î¨ºÎ™Ö *</label>
                                        <input type="text" id="newBuildingName" placeholder="Ïòà: ÎçîÏõêÌûêÏä§">
                                    </div>
                                    <div class="form-group">
                                        <label for="newBuildingUnits">Ï¥ù ÏÑ∏ÎåÄÏàò</label>
                                        <input type="number" id="newBuildingUnits" placeholder="Ïòà: 20">
                                    </div>
                                </div>
                                <div class="building-form-row">
                                    <div class="form-group">
                                        <label for="newBaseFee">Í∏∞Î≥∏Í¥ÄÎ¶¨ÎπÑ (Ïõê)</label>
                                        <input type="number" id="newBaseFee" placeholder="Ïòà: 30000">
                                    </div>
                                    <div class="form-group">
                                        <label for="waterMethod">ÏàòÎèÑÏöîÍ∏à Î∞©Ïãù</label>
                                        <select id="waterMethod">
                                            <option value="ÌÜ§ÏàòÎ∂ÑÌï†">ÌÜ§ÏàòÎ∂ÑÌï†</option>
                                            <option value="Í∞úÎ≥ÑÍ≥ÑÎüâ">Í∞úÎ≥ÑÍ≥ÑÎüâ</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="newBuildingAddress">Ï£ºÏÜå</label>
                                    <input type="text" id="newBuildingAddress" placeholder="Ïòà: Í≤ΩÍ∏∞ÎèÑ ÌååÏ£ºÏãú Ïö¥Ï†ïÎèô 123">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="roomNumber">Ìò∏Ïàò *</label>
                        <input type="text" id="roomNumber" name="roomNumber" placeholder="Ïòà: 101Ìò∏" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="moveInDate">Ï†ÑÏûÖÏùºÏûê *</label>
                        <input type="date" id="moveInDate" name="moveInDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="moveOutDate">Ï†ÑÏ∂úÏùºÏûê</label>
                        <input type="date" id="moveOutDate" name="moveOutDate">
                    </div>
                    
                    <div class="form-group">
                        <label for="customerStatus">Í±∞Ï£ºÏÉÅÌÉú *</label>
                        <select id="customerStatus" name="customerStatus" required>
                            <option value="Í±∞Ï£ºÏ§ë">Í±∞Ï£ºÏ§ë</option>
                            <option value="Ïù¥ÏÇ¨ÏôÑÎ£å">Ïù¥ÏÇ¨ÏôÑÎ£å</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn" onclick="closeModal()">Ï∑®ÏÜå</button>
                <button class="save-btn" onclick="saveCustomer()">Ï†ÄÏû•</button>
            </div>
        </div>
    </div>

    <script>
        // Íµ¨Í∏Ä ÏãúÌä∏ API ÏÑ§Ï†ï
        const API_KEY = 'AIzaSyD0tH5ebOAlUMnGrrLKdLAM3EzIuDAfPcA';
        const SHEET_ID = '1bFfjjg_Rn0VUx2JTFuaoJtG9WbxmQJiqPhKF4q9YDxg';
        
        let allCustomers = [];
        let filteredCustomers = [];
        let allBuildings = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let buildingMode = 'existing'; // 'existing' or 'new'
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ïã§Ìñâ
        document.addEventListener('DOMContentLoaded', async function() {
            await loadBuildings();
            await loadCustomers();
            setupEventListeners();
        });
        
        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
        function setupEventListeners() {
            // Î™®Îã¨ Îã´Í∏∞
            document.querySelector('.close').onclick = closeModal;
            
            // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
            window.onclick = function(event) {
                const modal = document.getElementById('customerModal');
                if (event.target === modal) {
                    closeModal();
                }
            };
            
            // Í≤ÄÏÉâ ÏûÖÎ†• Ïãú Ïã§ÏãúÍ∞Ñ Í≤ÄÏÉâ
            document.getElementById('searchInput').addEventListener('input', function() {
                searchCustomers();
            });
            
            // ÏóîÌÑ∞ÌÇ§Î°ú Í≤ÄÏÉâ
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchCustomers();
                }
            });
            
            // Ï†ÑÌôîÎ≤àÌò∏ ÏûÖÎ†• ÌòïÏãù ÏûêÎèô Ï°∞Ï†ï
            document.getElementById('customerPhone').addEventListener('input', function(e) {
                let value = e.target.value.replace(/[^0-9]/g, '');
                if (value.length >= 11) {
                    value = value.slice(0, 11);
                    value = value.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
                } else if (value.length >= 7) {
                    value = value.replace(/(\d{3})(\d{4})(\d*)/, '$1-$2-$3');
                } else if (value.length >= 3) {
                    value = value.replace(/(\d{3})(\d*)/, '$1-$2');
                }
                e.target.value = value;
            });
        }
        
        // Í±¥Î¨º Î™®Îìú ÌÜ†Í∏Ä
        function toggleBuildingMode(mode) {
            buildingMode = mode;
            
            const existingBtn = document.getElementById('existingBuildingBtn');
            const newBtn = document.getElementById('newBuildingBtn');
            const existingSection = document.getElementById('existingBuildingSection');
            const newSection = document.getElementById('newBuildingSection');
            
            if (mode === 'existing') {
                existingBtn.classList.add('active');
                newBtn.classList.remove('active');
                existingSection.style.display = 'block';
                newSection.style.display = 'none';
                
                // Í∏∞Ï°¥ Í±¥Î¨º ÏÑ†ÌÉù Ïãú ÌïÑÏàòÍ∞í ÏÑ§Ï†ï
                document.getElementById('buildingName').required = true;
                document.getElementById('newBuildingName').required = false;
            } else {
                existingBtn.classList.remove('active');
                newBtn.classList.add('active');
                existingSection.style.display = 'none';
                newSection.style.display = 'block';
                
                // Ïã†Í∑ú Í±¥Î¨º Îì±Î°ù Ïãú ÌïÑÏàòÍ∞í ÏÑ§Ï†ï
                document.getElementById('buildingName').required = false;
                document.getElementById('newBuildingName').required = true;
            }
        }
        
        // Í±¥Î¨º Î™©Î°ù Î°úÎìú
        async function loadBuildings() {
            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/buildings!A:G?key=${API_KEY}`
                );
                const data = await response.json();
                
                if (data.values && data.values.length > 1) {
                    allBuildings = data.values.slice(1).map(row => ({
                        id: row[0],
                        name: row[1],
                        address: row[2],
                        total_units: parseInt(row[3]) || 0,
                        water_billing_method: row[4] || 'ÌÜ§ÏàòÎ∂ÑÌï†',
                        base_management_fee: parseInt(row[5]) || 0,
                        created_date: row[6]
                    }));
                }
                
                updateBuildingSelect();
            } catch (error) {
                console.error('Í±¥Î¨º Î™©Î°ù Î°úÎìú Ïò§Î•ò:', error);
                showMessage('Í±¥Î¨º Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
            }
        }
        
        // Í±¥Î¨º ÎìúÎ°≠Îã§Ïö¥ ÏóÖÎç∞Ïù¥Ìä∏
        function updateBuildingSelect() {
            const buildingSelect = document.getElementById('buildingName');
            buildingSelect.innerHTML = '<option value="">Í±¥Î¨ºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>';
            
            allBuildings.forEach(building => {
                const option = document.createElement('option');
                option.value = building.name;
                option.textContent = building.name;
                buildingSelect.appendChild(option);
            });
        }
        
        // Í≥†Í∞ù Î™©Î°ù Î°úÎìú
        async function loadCustomers() {
            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/customers!A:K?key=${API_KEY}`
                );
                const data = await response.json();
                
                if (data.values && data.values.length > 1) {
                    allCustomers = data.values.slice(1).map(row => ({
                        id: row[0] || '',
                        name: row[1] || '',
                        phone: row[2] || '',
                        phone_last4: row[3] || '',
                        building_name: row[4] || '',
                        room_number: row[5] || '',
                        move_in_date: row[6] || '',
                        move_out_date: row[7] || '',
                        status: row[8] || 'Í±∞Ï£ºÏ§ë',
                        created_date: row[9] || '',
                        updated_date: row[10] || ''
                    }));
                    
                    filteredCustomers = [...allCustomers];
                    displayCustomers();
                } else {
                    displayNoData();
                }
                
            } catch (error) {
                console.error('Í≥†Í∞ù Î™©Î°ù Î°úÎìú Ïò§Î•ò:', error);
                showMessage('Í≥†Í∞ù Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
            }
        }
        
        // Í≥†Í∞ù Î™©Î°ù ÌëúÏãú
        function displayCustomers() {
            const tableContent = document.getElementById('tableContent');
            const customerCount = document.getElementById('customerCount');
            
            customerCount.textContent = filteredCustomers.length;
            
            if (filteredCustomers.length === 0) {
                displayNoData();
                return;
            }
            
            // ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò Í≥ÑÏÇ∞
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageCustomers = filteredCustomers.slice(startIndex, endIndex);
            
            const tableHTML = `
                <table class="customers-table">
                    <thead>
                        <tr>
                            <th>Í≥†Í∞ùÎ™Ö</th>
                            <th>Ï†ÑÌôîÎ≤àÌò∏</th>
                            <th>Í±¥Î¨ºÎ™Ö</th>
                            <th>Ìò∏Ïàò</th>
                            <th>Ï†ÑÏûÖÏùºÏûê</th>
                            <th>Ï†ÑÏ∂úÏùºÏûê</th>
                            <th>ÏÉÅÌÉú</th>
                            <th>Í¥ÄÎ¶¨</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pageCustomers.map(customer => `
                            <tr>
                                <td>${customer.name}</td>
                                <td>${customer.phone}</td>
                                <td>${customer.building_name}</td>
                                <td>${customer.room_number}</td>
                                <td>${customer.move_in_date}</td>
                                <td>${customer.move_out_date || '-'}</td>
                                <td>
                                    <span class="status-badge ${customer.status === 'Í±∞Ï£ºÏ§ë' ? 'status-active' : 'status-inactive'}">
                                        ${customer.status}
                                    </span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="action-btn edit-btn" onclick="editCustomer('${customer.id}')">ÏàòÏ†ï</button>
                                        <button class="action-btn delete-btn" onclick="deleteCustomer('${customer.id}', '${customer.name}')">ÏÇ≠Ï†ú</button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            tableContent.innerHTML = tableHTML;
            displayPagination();
        }
        
        // ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò ÌëúÏãú
        function displayPagination() {
            const totalPages = Math.ceil(filteredCustomers.length / itemsPerPage);
            const paginationContainer = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // Ïù¥Ï†Ñ Î≤ÑÌäº
            if (currentPage > 1) {
                paginationHTML += `<button class="page-btn" onclick="changePage(${currentPage - 1})">Ïù¥Ï†Ñ</button>`;
            }
            
            // ÌéòÏù¥ÏßÄ Î≤àÌò∏Îì§
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    paginationHTML += `<button class="page-btn active">${i}</button>`;
                } else {
                    paginationHTML += `<button class="page-btn" onclick="changePage(${i})">${i}</button>`;
                }
            }
            
            // Îã§Ïùå Î≤ÑÌäº
            if (currentPage < totalPages) {
                paginationHTML += `<button class="page-btn" onclick="changePage(${currentPage + 1})">Îã§Ïùå</button>`;
            }
            
            paginationContainer.innerHTML = paginationHTML;
        }
        
        // ÌéòÏù¥ÏßÄ Î≥ÄÍ≤Ω
        function changePage(page) {
            currentPage = page;
            displayCustomers();
        }
        
        // Í≥†Í∞ù Í≤ÄÏÉâ
        function searchCustomers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (searchTerm === '') {
                filteredCustomers = [...allCustomers];
            } else {
                filteredCustomers = allCustomers.filter(customer => 
                    customer.name.toLowerCase().includes(searchTerm) ||
                    customer.phone.includes(searchTerm) ||
                    customer.building_name.toLowerCase().includes(searchTerm) ||
                    customer.room_number.toLowerCase().includes(searchTerm)
                );
            }
            
            currentPage = 1;
            displayCustomers();
        }
        
        // Î™®Îã¨ Ïó¥Í∏∞
        function openModal(mode, customerId = null) {
            const modal = document.getElementById('customerModal');
            const modalTitle = document.getElementById('modalTitle');
            const form = document.getElementById('customerForm');
            
            // Í±¥Î¨º Î™®Îìú Ï¥àÍ∏∞Ìôî
            toggleBuildingMode('existing');
            
            if (mode === 'add') {
                modalTitle.textContent = 'Ïã†Í∑ú Í≥†Í∞ù Ï∂îÍ∞Ä';
                form.reset();
                document.getElementById('customerId').value = '';
                
                // Ïò§Îäò ÎÇ†ÏßúÎ•º Í∏∞Î≥∏Í∞íÏúºÎ°ú ÏÑ§Ï†ï
                document.getElementById('moveInDate').value = new Date().toISOString().split('T')[0];
            } else if (mode === 'edit' && customerId) {
                modalTitle.textContent = 'Í≥†Í∞ù Ï†ïÎ≥¥ ÏàòÏ†ï';
                const customer = allCustomers.find(c => c.id === customerId);
                if (customer) {
                    fillForm(customer);
                }
            }
            
            modal.style.display = 'block';
        }
        
        // ÌèºÏóê Í≥†Í∞ù Ï†ïÎ≥¥ Ï±ÑÏö∞Í∏∞
        function fillForm(customer) {
            document.getElementById('customerId').value = customer.id;
            document.getElementById('customerName').value = customer.name;
            document.getElementById('customerPhone').value = customer.phone;
            document.getElementById('buildingName').value = customer.building_name;
            document.getElementById('roomNumber').value = customer.room_number;
            document.getElementById('moveInDate').value = customer.move_in_date;
            document.getElementById('moveOutDate').value = customer.move_out_date;
            document.getElementById('customerStatus').value = customer.status;
        }
        
        // Î™®Îã¨ Îã´Í∏∞
        function closeModal() {
            document.getElementById('customerModal').style.display = 'none';
        }
        
        // Í≥†Í∞ù ÏàòÏ†ï
        function editCustomer(customerId) {
            openModal('edit', customerId);
        }
        
        // Í≥†Í∞ù ÏÇ≠Ï†ú
        async function deleteCustomer(customerId, customerName) {
            if (!confirm(`Ï†ïÎßêÎ°ú '${customerName}' Í≥†Í∞ùÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÏù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.`)) {
                return;
            }
            
            try {
                // Íµ¨Í∏Ä ÏãúÌä∏ÏóêÏÑú Ìï¥Îãπ Ìñâ Ï∞æÍ∏∞
                const rowIndex = allCustomers.findIndex(c => c.id === customerId) + 2; // Ìó§Îçî Ìè¨Ìï®
                
                if (rowIndex < 2) {
                    throw new Error('Í≥†Í∞ùÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                }
                
                // Google Apps ScriptÎ•º ÌÜµÌïú ÏÇ≠Ï†ú (Ïã§Ï†ú Íµ¨ÌòÑÏóêÏÑúÎäî ÌïÑÏöî)
                // await deleteCustomerFromSheet(rowIndex);
                
                // Î°úÏª¨ÏóêÏÑú Ï†úÍ±∞ (ÏûÑÏãú)
                allCustomers = allCustomers.filter(c => c.id !== customerId);
                searchCustomers(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                
                showMessage(`'${customerName}' Í≥†Í∞ùÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.`, 'success');
                
            } catch (error) {
                console.error('ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                showMessage('Í≥†Í∞ù ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message, 'error');
            }
        }
        
        // Í≥†Í∞ù Ï†ÄÏû•
        async function saveCustomer() {
            const form = document.getElementById('customerForm');
            
            // Ìèº Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
            if (!validateForm()) {
                return;
            }
            
            try {
                const formData = new FormData(form);
                let buildingName;
                
                // Í±¥Î¨ºÎ™Ö Ï≤òÎ¶¨
                if (buildingMode === 'new') {
                    // Ïã†Í∑ú Í±¥Î¨º Îì±Î°ù
                    const newBuilding = {
                        name: document.getElementById('newBuildingName').value.trim(),
                        address: document.getElementById('newBuildingAddress').value.trim(),
                        total_units: parseInt(document.getElementById('newBuildingUnits').value) || 10,
                        base_management_fee: parseInt(document.getElementById('newBaseFee').value) || 30000,
                        water_billing_method: document.getElementById('waterMethod').value
                    };
                    
                    if (!newBuilding.name) {
                        alert('Ïã†Í∑ú Í±¥Î¨ºÎ™ÖÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                        return;
                    }
                    
                    // Í±¥Î¨º Ï§ëÎ≥µ ÌôïÏù∏
                    if (allBuildings.some(b => b.name === newBuilding.name)) {
                        alert('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî Í±¥Î¨ºÎ™ÖÏûÖÎãàÎã§.');
                        return;
                    }
                    
                    await addNewBuilding(newBuilding);
                    buildingName = newBuilding.name;
                    
                } else {
                    buildingName = formData.get('buildingName');
                    if (!buildingName) {
                        alert('Í±¥Î¨ºÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                        return;
                    }
                }
                
                const customerData = {
                    id: formData.get('customerId'),
                    name: formData.get('customerName'),
                    phone: formData.get('customerPhone'),
                    phone_last4: formData.get('customerPhone').slice(-4),
                    building_name: buildingName,
                    room_number: formData.get('roomNumber'),
                    move_in_date: formData.get('moveInDate'),
                    move_out_date: formData.get('moveOutDate'),
                    status: formData.get('customerStatus'),
                    updated_date: new Date().toISOString().split('T')[0]
                };
                
                if (customerData.id) {
                    // ÏàòÏ†ï
                    await updateCustomer(customerData);
                    showMessage(`'${customerData.name}' Í≥†Í∞ù Ï†ïÎ≥¥Í∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.`, 'success');
                } else {
                    // Ï∂îÍ∞Ä
                    customerData.id = String(Date.now()); // ÏûÑÏãú ID
                    customerData.created_date = new Date().toISOString().split('T')[0];
                    await addCustomer(customerData);
                    showMessage(`'${customerData.name}' Í≥†Í∞ùÏù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.`, 'success');
                }
                
                closeModal();
                await loadCustomers(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                
            } catch (error) {
                console.error('Ï†ÄÏû• Ïò§Î•ò:', error);
                showMessage('Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message, 'error');
            }
        }
        
        // Ìèº Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
        function validateForm() {
            const form = document.getElementById('customerForm');
            
            if (!form.checkValidity()) {
                alert('ÌïÑÏàò Ìï≠Î™©ÏùÑ Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return false;
            }
            
            const phone = document.getElementById('customerPhone').value;
            const phoneRegex = /^010-\d{4}-\d{4}$/;
            if (!phoneRegex.test(phone)) {
                alert('Ï†ÑÌôîÎ≤àÌò∏ ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§. (010-1234-5678)');
                return false;
            }
            
            // Ï§ëÎ≥µ ÌôïÏù∏ (ÏàòÏ†ï Ïãú ÏûêÍ∏∞ ÏûêÏã† Ï†úÏô∏)
            const currentId = document.getElementById('customerId').value;
            const duplicateCustomer = allCustomers.find(c => 
                c.phone === phone && c.id !== currentId
            );
            
            if (duplicateCustomer) {
                alert('Ïù¥ÎØ∏ Îì±Î°ùÎêú Ï†ÑÌôîÎ≤àÌò∏ÏûÖÎãàÎã§.');
                return false;
            }
            
            return true;
        }
        
        // Ïã†Í∑ú Í±¥Î¨º Ï∂îÍ∞Ä
        async function addNewBuilding(buildingData) {
            try {
                // Ïã§Ï†ú Íµ¨ÌòÑÏóêÏÑúÎäî Google Apps Script API ÏÇ¨Ïö©
                // await addBuildingToSheet(buildingData);
                
                // ÏûÑÏãúÎ°ú Î°úÏª¨ Î∞∞Ïó¥Ïóê Ï∂îÍ∞Ä
                buildingData.id = String(allBuildings.length + 1);
                buildingData.created_date = new Date().toISOString().split('T')[0];
                allBuildings.push(buildingData);
                updateBuildingSelect();
                
                console.log('Ïã†Í∑ú Í±¥Î¨º Ï∂îÍ∞Ä:', buildingData);
                
            } catch (error) {
                throw new Error('Í±¥Î¨º Îì±Î°ùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }
        
        // Í≥†Í∞ù Ï∂îÍ∞Ä
        async function addCustomer(customerData) {
            try {
                // Ïã§Ï†ú Íµ¨ÌòÑÏóêÏÑúÎäî Google Apps Script API ÏÇ¨Ïö©
                // await addCustomerToSheet(customerData);
                
                // ÏûÑÏãúÎ°ú Î°úÏª¨ Î∞∞Ïó¥Ïóê Ï∂îÍ∞Ä
                allCustomers.push(customerData);
                
                console.log('Í≥†Í∞ù Ï∂îÍ∞Ä:', customerData);
                
            } catch (error) {
                throw new Error('Í≥†Í∞ù Ï∂îÍ∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }
        
        // Í≥†Í∞ù ÏàòÏ†ï
        async function updateCustomer(customerData) {
            try {
                // Ïã§Ï†ú Íµ¨ÌòÑÏóêÏÑúÎäî Google Apps Script API ÏÇ¨Ïö©
                // await updateCustomerInSheet(customerData);
                
                // ÏûÑÏãúÎ°ú Î°úÏª¨ Î∞∞Ïó¥ÏóêÏÑú ÏàòÏ†ï
                const index = allCustomers.findIndex(c => c.id === customerData.id);
                if (index !== -1) {
                    allCustomers[index] = { ...allCustomers[index], ...customerData };
                }
                
                console.log('Í≥†Í∞ù ÏàòÏ†ï:', customerData);
                
            } catch (error) {
                throw new Error('Í≥†Í∞ù ÏàòÏ†ïÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }
        
        // Î©îÏãúÏßÄ ÌëúÏãú
        function showMessage(message, type = 'info') {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `${type}-message`;
            messageDiv.textContent = message;
            
            container.innerHTML = '';
            container.appendChild(messageDiv);
            
            // 5Ï¥à ÌõÑ ÏûêÎèô Ï†úÍ±∞
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }
        
        // Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå ÌëúÏãú
        function displayNoData() {
            const tableContent = document.getElementById('tableContent');
            tableContent.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.
                </div>
            `;
            document.getElementById('pagination').innerHTML = '';
        }
    </script>
</body>
</html>

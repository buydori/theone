<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë”ì›ì£¼íƒê´€ë¦¬ - ìš”ê¸ˆì¡°íšŒ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans KR', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .search-section {
            padding: 40px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .search-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .result-section {
            display: none;
            padding: 40px;
            border-top: 1px solid #e1e8ed;
            background: #f8f9fa;
        }
        
        .customer-info {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .customer-info h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f1f3f4;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .fee-breakdown {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .fee-breakdown h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .fee-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            font-size: 16px;
        }
        
        .fee-item.total {
            border-top: 2px solid #2c3e50;
            margin-top: 15px;
            padding-top: 15px;
            font-weight: bold;
            font-size: 18px;
            color: #e74c3c;
        }
        
        .water-detail {
            background: #e8f4fd;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .water-detail h4 {
            color: #2980b9;
            margin-bottom: 15px;
        }
        
        .water-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 14px;
        }
        
        .account-info {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
        }
        
        .account-info h3 {
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .account-details {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .copy-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .copy-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .error-message {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 480px) {
            .container {
                margin: 10px;
            }
            
            .search-section, .result-section {
                padding: 20px;
            }
            
            .water-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ë”ì›ì£¼íƒê´€ë¦¬</h1>
            <p>ê´€ë¦¬ë¹„ ì¡°íšŒ ë° ë‚©ë¶€ ì•ˆë‚´</p>
        </div>
        
        <div class="search-section">
            <form id="searchForm">
                <div class="form-group">
                    <label for="customerName">ê³ ê°ëª…</label>
                    <input type="text" id="customerName" name="customerName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                </div>
                
                <div class="form-group">
                    <label for="phoneLast4">ì „í™”ë²ˆí˜¸ ë 4ìë¦¬</label>
                    <input type="text" id="phoneLast4" name="phoneLast4" placeholder="ì˜ˆ: 1234" maxlength="4" pattern="[0-9]{4}" required>
                </div>
                
                <button type="submit" class="search-btn">ìš”ê¸ˆ ì¡°íšŒ</button>
            </form>
        </div>
        
        <div class="result-section" id="resultSection">
            <div class="customer-info" id="customerInfo">
                <h3>ê³ ê° ì •ë³´</h3>
                <div class="info-row">
                    <span>ê³ ê°ëª…:</span>
                    <span id="displayName">-</span>
                </div>
                <div class="info-row">
                    <span>ê±´ë¬¼ëª…:</span>
                    <span id="displayBuilding">-</span>
                </div>
                <div class="info-row">
                    <span>í˜¸ìˆ˜:</span>
                    <span id="displayRoom">-</span>
                </div>
                <div class="info-row">
                    <span>ì „í™”ë²ˆí˜¸:</span>
                    <span id="displayPhone">-</span>
                </div>
            </div>
            
            <div class="fee-breakdown" id="feeBreakdown">
                <h3>2024ë…„ 7ì›” ê´€ë¦¬ë¹„ ë‚´ì—­</h3>
                
                <div class="fee-item">
                    <span>ê¸°ë³¸ê´€ë¦¬ë¹„:</span>
                    <span id="baseFee">0ì›</span>
                </div>
                
                <div class="fee-item" id="waterFeeRow">
                    <span>ìˆ˜ë„ìš”ê¸ˆ:</span>
                    <span id="waterFee">0ì›</span>
                </div>
                
                <div class="fee-item" id="unpaidFeeRow">
                    <span>ë¯¸ë‚©ìš”ê¸ˆ:</span>
                    <span id="unpaidFee">0ì›</span>
                </div>
                
                <div class="fee-item total">
                    <span>ì´ í•©ê³„:</span>
                    <span id="totalFee">0ì›</span>
                </div>
                
                <div class="water-detail" id="waterDetail">
                    <h4>ğŸ’§ ìˆ˜ë„ìš”ê¸ˆ ìƒì„¸ ë‚´ì—­</h4>
                    <div class="water-info">
                        <div>ê±´ë¬¼ ì´ ì²­êµ¬ìš”ê¸ˆ: <strong id="buildingTotalBill">0ì›</strong></div>
                        <div>ê±´ë¬¼ ì´ ì‚¬ìš©ëŸ‰: <strong id="buildingTotalUsage">0í†¤</strong></div>
                        <div>í†¤ë‹¹ ë‹¨ê°€: <strong id="pricePerTon">0ì›</strong></div>
                        <div>ë‚˜ì˜ ì‚¬ìš©ëŸ‰: <strong id="myUsage">0í†¤</strong></div>
                    </div>
                </div>
            </div>
            
            <div class="account-info">
                <h3>ğŸ’³ ë‚©ë¶€ ê³„ì¢Œ ì•ˆë‚´</h3>
                <div class="account-details">
                    <div style="font-size: 18px; font-weight: bold;">ë”ì›í´ë¦°ì•¤ì¼€ì–´ (ì±„ì² )</div>
                    <div style="font-size: 20px; margin-top: 10px;">ì¹´ì¹´ì˜¤ë±…í¬ 3333-31-7563438</div>
                </div>
                <button class="copy-btn" onclick="copyAccountInfo()">ê³„ì¢Œë²ˆí˜¸ ë³µì‚¬</button>
            </div>
        </div>
    </div>

    <script>
        // êµ¬ê¸€ ì‹œíŠ¸ API ì„¤ì •
        const API_KEY = 'AIzaSyD0tH5ebOAlUMnGrrLKdLAM3EzIuDAfPcA';
        const SHEET_ID = '1bFfjjg_Rn0VUx2JTFuaoJtG9WbxmQJiqPhKF4q9YDxg';
        
        // í¼ ì œì¶œ ì´ë²¤íŠ¸
        document.getElementById('searchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('customerName').value.trim();
            const phoneLast4 = document.getElementById('phoneLast4').value.trim();
            
            if (!name || !phoneLast4) {
                alert('ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ ë 4ìë¦¬ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            await searchCustomerFees(name, phoneLast4);
        });
        
        // ê³ ê° ìš”ê¸ˆ ì¡°íšŒ í•¨ìˆ˜
        async function searchCustomerFees(name, phoneLast4) {
            try {
                showLoading();
                
                // ê³ ê° ì •ë³´ ì¡°íšŒ
                const customer = await findCustomer(name, phoneLast4);
                if (!customer) {
                    showError('ì¼ì¹˜í•˜ëŠ” ê³ ê° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // ì›”ë³„ ìš”ê¸ˆ ì¡°íšŒ (í˜„ì¬ì›”)
                const currentMonth = '2024-07'; // ì‹¤ì œë¡œëŠ” í˜„ì¬ ë‚ ì§œë¡œ ì„¤ì •
                const feeData = await getMonthlyFee(customer.customer_id, currentMonth);
                
                // ìˆ˜ë„ìš”ê¸ˆ ìƒì„¸ ì •ë³´ ì¡°íšŒ
                const waterData = await getWaterBillingDetail(customer.customer_id, currentMonth);
                
                // ê²°ê³¼ í‘œì‹œ
                displayResults(customer, feeData, waterData);
                
            } catch (error) {
                console.error('ì¡°íšŒ ì¤‘ ì˜¤ë¥˜:', error);
                showError('ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }
        
        // ê³ ê° ì •ë³´ ì°¾ê¸°
        async function findCustomer(name, phoneLast4) {
            const response = await fetch(
                `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/customers!A:K?key=${API_KEY}`
            );
            const data = await response.json();
            
            if (!data.values) return null;
            
            const rows = data.values.slice(1); // í—¤ë” ì œì™¸
            const customer = rows.find(row => 
                row[1] === name && row[3] === phoneLast4 && row[7] === 'ê±°ì£¼ì¤‘'
            );
            
            if (!customer) return null;
            
            return {
                customer_id: customer[0],
                name: customer[1],
                phone: customer[2],
                building_name: customer[4],
                room_number: customer[5]
            };
        }
        
        // ì›”ë³„ ìš”ê¸ˆ ì¡°íšŒ
        async function getMonthlyFee(customerId, yearMonth) {
            const response = await fetch(
                `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/monthly_fees!A:L?key=${API_KEY}`
            );
            const data = await response.json();
            
            if (!data.values) return null;
            
            const rows = data.values.slice(1);
            const feeRow = rows.find(row => 
                row[1] === customerId && row[2] === yearMonth
            );
            
            if (!feeRow) return null;
            
            return {
                base_fee: parseInt(feeRow[3]) || 0,
                water_fee: parseInt(feeRow[4]) || 0,
                unpaid_fee: parseInt(feeRow[5]) || 0,
                total_fee: parseInt(feeRow[6]) || 0,
                payment_status: feeRow[7] || 'ë¯¸ë‚©'
            };
        }
        
        // ìˆ˜ë„ìš”ê¸ˆ ìƒì„¸ ì •ë³´ ì¡°íšŒ
        async function getWaterBillingDetail(customerId, yearMonth) {
            const response = await fetch(
                `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/water_billing!A:I?key=${API_KEY}`
            );
            const data = await response.json();
            
            if (!data.values) return null;
            
            const rows = data.values.slice(1);
            const waterRow = rows.find(row => 
                row[6] === customerId && row[2] === yearMonth
            );
            
            if (!waterRow) return null;
            
            return {
                building_name: waterRow[1],
                total_bill_amount: parseInt(waterRow[3]) || 0,
                total_usage_tons: parseFloat(waterRow[4]) || 0,
                price_per_ton: parseInt(waterRow[5]) || 0,
                customer_usage_tons: parseFloat(waterRow[7]) || 0,
                customer_water_fee: parseInt(waterRow[8]) || 0
            };
        }
        
        // ê²°ê³¼ í‘œì‹œ
        function displayResults(customer, feeData, waterData) {
            // ê³ ê° ì •ë³´ í‘œì‹œ
            document.getElementById('displayName').textContent = customer.name;
            document.getElementById('displayBuilding').textContent = customer.building_name;
            document.getElementById('displayRoom').textContent = customer.room_number;
            document.getElementById('displayPhone').textContent = customer.phone;
            
            if (feeData) {
                // ìš”ê¸ˆ ì •ë³´ í‘œì‹œ
                document.getElementById('baseFee').textContent = formatCurrency(feeData.base_fee);
                document.getElementById('waterFee').textContent = formatCurrency(feeData.water_fee);
                document.getElementById('unpaidFee').textContent = formatCurrency(feeData.unpaid_fee);
                document.getElementById('totalFee').textContent = formatCurrency(feeData.total_fee);
                
                // 0ì›ì¸ í•­ëª© ìˆ¨ê¸°ê¸°
                const waterFeeRow = document.getElementById('waterFeeRow');
                const unpaidFeeRow = document.getElementById('unpaidFeeRow');
                const waterDetail = document.getElementById('waterDetail');
                
                if (feeData.water_fee === 0) {
                    waterFeeRow.style.display = 'none';
                    waterDetail.style.display = 'none';
                } else {
                    waterFeeRow.style.display = 'flex';
                    waterDetail.style.display = 'block';
                }
                
                if (feeData.unpaid_fee === 0) {
                    unpaidFeeRow.style.display = 'none';
                } else {
                    unpaidFeeRow.style.display = 'flex';
                }
            }
            
            if (waterData && feeData.water_fee > 0) {
                // ìˆ˜ë„ìš”ê¸ˆ ìƒì„¸ ì •ë³´ í‘œì‹œ
                document.getElementById('buildingTotalBill').textContent = formatCurrency(waterData.total_bill_amount);
                document.getElementById('buildingTotalUsage').textContent = waterData.total_usage_tons + 'í†¤';
                document.getElementById('pricePerTon').textContent = formatCurrency(waterData.price_per_ton);
                document.getElementById('myUsage').textContent = waterData.customer_usage_tons + 'í†¤';
            }
            
            // ê²°ê³¼ ì„¹ì…˜ í‘œì‹œ
            document.getElementById('resultSection').style.display = 'block';
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        // ê³„ì¢Œ ì •ë³´ ë³µì‚¬
        function copyAccountInfo() {
            const accountInfo = 'ì¹´ì¹´ì˜¤ë±…í¬ 3333-31-7563438 ë”ì›í´ë¦°ì•¤ì¼€ì–´(ì±„ì² )';
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(accountInfo).then(() => {
                    alert('ê³„ì¢Œ ì •ë³´ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                });
            } else {
                // êµ¬í˜• ë¸Œë¼ìš°ì € ì§€ì›
                const textArea = document.createElement('textarea');
                textArea.value = accountInfo;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('ê³„ì¢Œ ì •ë³´ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        }
        
        // ë¡œë”© í‘œì‹œ
        function showLoading() {
            const resultSection = document.getElementById('resultSection');
            resultSection.innerHTML = '<div class="loading">ì¡°íšŒ ì¤‘...</div>';
            resultSection.style.display = 'block';
        }
        
        // ì˜¤ë¥˜ í‘œì‹œ
        function showError(message) {
            const resultSection = document.getElementById('resultSection');
            resultSection.innerHTML = `<div class="error-message">${message}</div>`;
            resultSection.style.display = 'block';
        }
        
        // ìˆ«ìë¥¼ í†µí™” í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        function formatCurrency(amount) {
            return new Intl.NumberFormat('ko-KR').format(amount) + 'ì›';
        }
        
        // ì „í™”ë²ˆí˜¸ ì…ë ¥ ì‹œ ìˆ«ìë§Œ í—ˆìš©
        document.getElementById('phoneLast4').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });
    </script>
</body>
</html>

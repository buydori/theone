<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로고 자동합성기 - 스마트 배치처리</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.3em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .panel h2 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .upload-area {
            border: 3px dashed #e2e8f0;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f8faff;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .upload-area.has-logo {
            border-color: #10b981;
            background: #ecfdf5;
        }

        .upload-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #a0aec0;
        }

        .saved-logo-indicator {
            background: #10b981;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            display: inline-block;
            margin-bottom: 10px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6b7280;
            box-shadow: 0 4px 15px rgba(107, 114, 128, 0.3);
        }

        .btn-danger {
            background: #ef4444;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .logo-preview {
            text-align: center;
            margin-bottom: 15px;
        }

        .logo-preview img {
            max-width: 100%;
            max-height: 120px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .main-workspace {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .workspace-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .workspace-header h2 {
            color: #4a5568;
            font-size: 1.5em;
            margin: 0;
        }

        .workspace-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            min-height: 200px;
            border: 2px dashed #e2e8f0;
            border-radius: 15px;
            padding: 20px;
        }

        .images-grid.dragover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .image-item {
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            cursor: move;
            transition: all 0.3s ease;
            background: white;
        }

        .image-item:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .image-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .image-item .order-number {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .image-item .file-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px;
            font-size: 0.8em;
            text-align: center;
        }

        .image-item .remove-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,0,0,0.9);
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .progress-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8faff;
            border-radius: 15px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .status-text {
            font-size: 1em;
            color: #4a5568;
            font-weight: 500;
            text-align: center;
        }

        .results-section {
            margin-top: 30px;
            display: none;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .result-item {
            background: #f8faff;
            border: 1px solid #e2e8f0;
            border-radius: 15px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .result-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .result-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            cursor: pointer;
        }

        .result-item .info {
            padding: 15px;
        }

        .result-item .info h3 {
            color: #4a5568;
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .result-item .info p {
            color: #6b7280;
            font-size: 0.9em;
        }

        .result-item .info .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .download-btn, .delete-btn {
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            flex: 1;
            transition: all 0.3s ease;
        }

        .download-btn {
            background: #10b981;
            color: white;
        }

        .download-btn:hover {
            background: #059669;
        }

        .delete-btn {
            background: #ef4444;
            color: white;
        }

        .delete-btn:hover {
            background: #dc2626;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .empty-state .icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 90%;
            max-height: 90%;
        }

        .modal-content img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 10px;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.5em;
            cursor: pointer;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .sidebar {
                order: 2;
            }
            
            .main-workspace {
                order: 1;
            }

            .workspace-header {
                flex-direction: column;
                align-items: stretch;
            }

            .workspace-controls {
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.2em;
            }
            
            .images-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }
            
            .results-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎨 로고 자동합성기</h1>
            <p>한 번 설정한 로고로 여러 이미지를 자동 처리하는 스마트 배치 도구</p>
        </div>

        <div class="main-content">
            <!-- 사이드바 -->
            <div class="sidebar">
                <!-- 로고 설정 패널 -->
                <div class="panel">
                    <h2>🏷️ 로고 설정</h2>
                    <div class="upload-area" id="logoUpload">
                        <div class="upload-icon">📎</div>
                        <p>로고 파일을 업로드하거나<br>드래그하여 설정하세요</p>
                        <input type="file" id="logoInput" accept="image/*" style="display: none;">
                    </div>
                    <div class="logo-preview" id="logoPreview"></div>
                    <button class="btn btn-danger" onclick="window.clearSavedLogo()" id="clearLogoBtn" style="display: none;">
                        🗑️ 저장된 로고 삭제
                    </button>
                </div>

                <!-- 합성 설정 패널 -->
                <div class="panel">
                    <h2>⚙️ 합성 설정</h2>
                    <div class="form-group">
                        <label for="logoPosition">로고 위치:</label>
                        <select id="logoPosition">
                            <option value="우측 상단">우측 상단</option>
                            <option value="좌측 상단">좌측 상단</option>
                            <option value="우측 하단">우측 하단</option>
                            <option value="좌측 하단">좌측 하단</option>
                            <option value="중앙">중앙</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="logoSize">로고 크기 (%):</label>
                        <select id="logoSize">
                            <option value="5">5% (매우 작게)</option>
                            <option value="10">10% (작게)</option>
                            <option value="15" selected>15% (기본)</option>
                            <option value="20">20% (약간 크게)</option>
                            <option value="25">25% (크게)</option>
                            <option value="30">30% (매우 크게)</option>
                            <option value="40">40% (특대)</option>
                            <option value="50">50% (초대형)</option>
                            <option value="75">75% (거대)</option>
                            <option value="100">100% (전체 크기)</option>
                            <option value="150">150% (1.5배)</option>
                            <option value="200">200% (2배)</option>
                            <option value="250">250% (2.5배)</option>
                            <option value="300">300% (3배)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="fileName">파일명 접두사:</label>
                        <input type="text" id="fileName" placeholder="예: 인형" value="합성이미지">
                    </div>
                </div>

                <!-- 처리 패널 -->
                <div class="panel">
                    <h2>🚀 처리 실행</h2>
                    <button class="btn" onclick="window.processImages()" id="processBtn" disabled>
                        ✨ 로고 합성 시작
                    </button>
                    <button class="btn btn-secondary" onclick="window.downloadAllResults()" id="downloadAllBtn" style="display: none;">
                        💾 전체 다운로드
                    </button>
                    <button class="btn btn-danger" onclick="window.clearAllResults()" id="clearResultsBtn" style="display: none;">
                        🗑️ 결과 전체 삭제
                    </button>
                </div>
            </div>

            <!-- 메인 작업공간 -->
            <div class="main-workspace">
                <div class="workspace-header">
                    <h2>📁 이미지 작업공간</h2>
                    <div class="workspace-controls">
                        <button class="btn" onclick="window.selectImages()" style="width: auto;">
                            📂 이미지 선택
                        </button>
                        <button class="btn btn-secondary" onclick="window.shuffleImages()" style="width: auto;">
                            🔀 순서 섞기
                        </button>
                        <button class="btn btn-danger" onclick="window.clearAllImages()" style="width: auto;">
                            🗑️ 전체 삭제
                        </button>
                    </div>
                </div>

                <div class="images-grid" id="imagesGrid">
                    <div class="empty-state">
                        <div class="icon">📁</div>
                        <p>이미지를 드래그하거나 '이미지 선택' 버튼을 클릭하여<br>합성할 이미지들을 추가하세요</p>
                    </div>
                </div>

                <input type="file" id="imagesInput" accept="image/*" multiple style="display: none;">

                <!-- 진행 상황 -->
                <div class="progress-section" id="progressSection">
                    <div class="status-text" id="statusText">처리 준비 중...</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                </div>

                <!-- 결과 표시 -->
                <div class="results-section" id="resultsSection">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #4a5568; margin: 0;">🎉 합성 결과</h3>
                        <div style="display: flex; gap: 10px;">
                            <span id="resultCount" style="color: #6b7280; font-size: 0.9em;">0개 결과</span>
                            <button class="btn btn-danger" onclick="window.clearAllResults()" style="width: auto; padding: 6px 15px; font-size: 0.9em;">
                                🗑️ 전체 삭제
                            </button>
                        </div>
                    </div>
                    <div class="results-grid" id="resultsGrid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 이미지 확대 모달 -->
    <div class="modal" id="imageModal" onclick="closeImageModal()">
        <div class="modal-content">
            <button class="modal-close" onclick="closeImageModal()">×</button>
            <img id="modalImage" src="" alt="확대 이미지">
        </div>
    </div>

    <script>
        let savedLogo = null;
        let baseImages = [];
        let processedResults = [];

        // 페이지 로드 시 저장된 로고 복원
        function loadSavedLogo() {
            try {
                const savedLogoData = localStorage.getItem('autoLogoComposer_logo');
                if (savedLogoData) {
                    savedLogo = JSON.parse(savedLogoData);
                    displaySavedLogo();
                    console.log('✅ 저장된 로고를 성공적으로 복원했습니다.');
                } else {
                    console.log('ℹ️ 저장된 로고가 없습니다.');
                }
            } catch (e) {
                console.warn('⚠️ 저장된 로고 데이터 복원 실패:', e);
                localStorage.removeItem('autoLogoComposer_logo');
            }
        }

        // 저장된 로고 표시
        function displaySavedLogo() {
            const logoUpload = document.getElementById('logoUpload');
            const logoPreview = document.getElementById('logoPreview');
            const clearBtn = document.getElementById('clearLogoBtn');

            if (!logoUpload || !logoPreview || !clearBtn) {
                console.error('❌ 로고 표시에 필요한 DOM 요소를 찾을 수 없습니다.');
                return;
            }

            // 기존 input 요소 보존
            const existingInput = document.getElementById('logoInput');
            
            logoUpload.classList.add('has-logo');
            logoUpload.innerHTML = `
                <div class="saved-logo-indicator">✅ 저장된 로고 사용 중</div>
                <div class="upload-icon">🏷️</div>
                <p>새 로고로 교체하려면<br>파일을 드래그하세요</p>
            `;
            
            // input 요소 다시 추가
            if (existingInput) {
                logoUpload.appendChild(existingInput);
            } else {
                // input 요소가 없으면 새로 생성
                const newInput = document.createElement('input');
                newInput.type = 'file';
                newInput.id = 'logoInput';
                newInput.accept = 'image/*';
                newInput.style.display = 'none';
                logoUpload.appendChild(newInput);
            }

            logoPreview.innerHTML = `
                <img src="${savedLogo.dataUrl}" alt="저장된 로고">
                <p style="margin-top: 10px; font-size: 0.9em; color: #6b7280;">
                    ${savedLogo.fileName} (자동 저장됨)
                </p>
            `;

            clearBtn.style.display = 'block';
            checkCanProcess();
        }

        // 로고 저장
        function saveLogo(file, dataUrl) {
            savedLogo = {
                fileName: file.name,
                dataUrl: dataUrl,
                size: file.size,
                type: file.type,
                savedAt: new Date().toISOString()
            };

            localStorage.setItem('autoLogoComposer_logo', JSON.stringify(savedLogo));
            displaySavedLogo();
        }

        // 저장된 로고 삭제 (전역 함수로 변경)
        window.clearSavedLogo = function() {
            if (confirm('저장된 로고를 삭제하시겠습니까?')) {
                savedLogo = null;
                localStorage.removeItem('autoLogoComposer_logo');
                
                const logoUpload = document.getElementById('logoUpload');
                const logoPreview = document.getElementById('logoPreview');
                const clearBtn = document.getElementById('clearLogoBtn');

                if (logoUpload) {
                    // 기존 input 요소 보존
                    const existingInput = document.getElementById('logoInput');
                    
                    logoUpload.classList.remove('has-logo');
                    logoUpload.innerHTML = `
                        <div class="upload-icon">📎</div>
                        <p>로고 파일을 업로드하거나<br>드래그하여 설정하세요</p>
                    `;
                    
                    // input 요소 다시 추가
                    if (existingInput) {
                        logoUpload.appendChild(existingInput);
                    } else {
                        // input 요소가 없으면 새로 생성
                        const newInput = document.createElement('input');
                        newInput.type = 'file';
                        newInput.id = 'logoInput';
                        newInput.accept = 'image/*';
                        newInput.style.display = 'none';
                        logoUpload.appendChild(newInput);
                    }
                }

                if (logoPreview) logoPreview.innerHTML = '';
                if (clearBtn) clearBtn.style.display = 'none';
                checkCanProcess();
            }
        };

        // 드래그 앤 드롭 이벤트 설정
        function setupDragAndDrop() {
            // DOM이 완전히 로드된 후 잠시 대기
            setTimeout(() => {
                // 필수 요소들 확인
                const requiredElements = {
                    logoUpload: document.getElementById('logoUpload'),
                    imagesGrid: document.getElementById('imagesGrid'),
                    logoInput: document.getElementById('logoInput'),
                    imagesInput: document.getElementById('imagesInput')
                };

                // 누락된 요소 확인
                const missingElements = Object.entries(requiredElements)
                    .filter(([name, element]) => !element)
                    .map(([name]) => name);

                if (missingElements.length > 0) {
                    console.error('❌ 다음 DOM 요소들을 찾을 수 없습니다:', missingElements);
                    return false;
                }

                const { logoUpload, imagesGrid, logoInput, imagesInput } = requiredElements;

                // 로고 업로드 이벤트
                logoUpload.addEventListener('click', () => {
                    const currentLogoInput = document.getElementById('logoInput');
                    if (currentLogoInput) {
                        currentLogoInput.click();
                    }
                });

                logoUpload.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    logoUpload.classList.add('dragover');
                });

                logoUpload.addEventListener('dragleave', () => {
                    logoUpload.classList.remove('dragover');
                });

                logoUpload.addEventListener('drop', (e) => {
                    e.preventDefault();
                    logoUpload.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0 && files[0].type.startsWith('image/')) {
                        handleLogoUpload(files[0]);
                    }
                });

                // 이미지 그리드 이벤트
                imagesGrid.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    imagesGrid.classList.add('dragover');
                });

                imagesGrid.addEventListener('dragleave', () => {
                    imagesGrid.classList.remove('dragover');
                });

                imagesGrid.addEventListener('drop', (e) => {
                    e.preventDefault();
                    imagesGrid.classList.remove('dragover');
                    const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
                    if (files.length > 0) {
                        handleImagesUpload(files);
                    }
                });

                // 파일 input 이벤트 (이벤트 위임 사용)
                document.addEventListener('change', (e) => {
                    if (e.target && e.target.id === 'logoInput') {
                        if (e.target.files.length > 0) {
                            handleLogoUpload(e.target.files[0]);
                        }
                    } else if (e.target && e.target.id === 'imagesInput') {
                        const files = Array.from(e.target.files);
                        handleImagesUpload(files);
                    }
                });

                console.log('✅ 드래그 앤 드롭 이벤트가 성공적으로 설정되었습니다.');
                return true;
            }, 100);
        }

        // 로고 업로드 처리
        function handleLogoUpload(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                saveLogo(file, e.target.result);
            };
            reader.readAsDataURL(file);
        }

        // 이미지 선택 (전역 함수로 변경)
        window.selectImages = function() {
            const imagesInput = document.getElementById('imagesInput');
            if (imagesInput) {
                imagesInput.click();
                console.log('이미지 선택 창이 열렸습니다.');
            } else {
                console.warn('이미지 input 요소를 찾을 수 없습니다.');
            }
        };

        // 베이스 이미지 업로드 처리
        function handleImagesUpload(files) {
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        baseImages.push({
                            file: file,
                            dataUrl: e.target.result,
                            id: Date.now() + Math.random(),
                            fileName: file.name
                        });
                        updateImagesDisplay();
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // 이미지 디스플레이 업데이트
        function updateImagesDisplay() {
            const imagesGrid = document.getElementById('imagesGrid');
            
            if (baseImages.length === 0) {
                imagesGrid.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">📁</div>
                        <p>이미지를 드래그하거나 '이미지 선택' 버튼을 클릭하여<br>합성할 이미지들을 추가하세요</p>
                    </div>
                `;
            } else {
                imagesGrid.innerHTML = '';
                baseImages.forEach((img, index) => {
                    const div = document.createElement('div');
                    div.className = 'image-item';
                    div.draggable = true;
                    div.innerHTML = `
                        <img src="${img.dataUrl}" alt="이미지 ${index + 1}">
                        <div class="order-number">${index + 1}</div>
                        <div class="file-name">${img.fileName}</div>
                        <button class="remove-btn" onclick="removeImage(${index})">×</button>
                    `;
                    
                    // 드래그 앤 드롭으로 순서 변경
                    div.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', index);
                    });
                    
                    div.addEventListener('dragover', (e) => {
                        e.preventDefault();
                    });
                    
                    div.addEventListener('drop', (e) => {
                        e.preventDefault();
                        const draggedIndex = parseInt(e.dataTransfer.getData('text/plain'));
                        const targetIndex = index;
                        
                        if (draggedIndex !== targetIndex) {
                            const temp = baseImages[draggedIndex];
                            baseImages[draggedIndex] = baseImages[targetIndex];
                            baseImages[targetIndex] = temp;
                            updateImagesDisplay();
                        }
                    });
                    
                    imagesGrid.appendChild(div);
                });
            }
            
            checkCanProcess();
        }

        // 이미지 제거
        function removeImage(index) {
            baseImages.splice(index, 1);
            updateImagesDisplay();
        }

        // 이미지 순서 섞기 (전역 함수로 변경)
        window.shuffleImages = function() {
            if (baseImages.length < 2) {
                console.log('섞을 이미지가 충분하지 않습니다.');
                alert('섞을 이미지가 2개 이상 필요합니다.');
                return;
            }
            
            for (let i = baseImages.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [baseImages[i], baseImages[j]] = [baseImages[j], baseImages[i]];
            }
            updateImagesDisplay();
            console.log('✅ 이미지 순서가 섞였습니다.');
        };

        // 전체 이미지 삭제
        function clearAllImages() {
            if (baseImages.length > 0 && confirm('모든 이미지를 삭제하시겠습니까?')) {
                baseImages = [];
                updateImagesDisplay();
                
                // 결과도 함께 삭제할지 확인
                if (processedResults.length > 0) {
                    if (confirm('합성 결과도 함께 삭제하시겠습니까?')) {
                        clearAllResults();
                    }
                }
            }
        }

        // 처리 가능 여부 확인
        function checkCanProcess() {
            const processBtn = document.getElementById('processBtn');
            if (!processBtn) return;
            
            const canProcess = savedLogo && baseImages.length > 0;
            
            processBtn.disabled = !canProcess;
            processBtn.innerHTML = canProcess ? 
                '✨ 로고 합성 시작' : 
                '🚫 로고와 이미지가 필요합니다';
        }

        // 진행 상황 업데이트
        function updateProgress(percentage, statusText) {
            const progressSection = document.getElementById('progressSection');
            const progressFill = document.getElementById('progressFill');
            const statusTextEl = document.getElementById('statusText');
            
            if (progressSection) progressSection.style.display = 'block';
            if (progressFill) progressFill.style.width = percentage + '%';
            if (statusTextEl) statusTextEl.textContent = statusText;
        }

        // 이미지 합성 처리 (전역 함수로 변경)
        window.processImages = async function() {
            if (!savedLogo || baseImages.length === 0) {
                alert('로고와 이미지를 모두 준비해주세요.');
                return;
            }

            const processBtn = document.getElementById('processBtn');
            const fileName = document.getElementById('fileName').value || '합성이미지';
            const logoPosition = document.getElementById('logoPosition').value;
            const logoSize = parseInt(document.getElementById('logoSize').value);

            processBtn.disabled = true;
            processBtn.innerHTML = '🔄 합성 중...';

            processedResults = [];
            document.getElementById('resultsSection').style.display = 'none';

            try {
                updateProgress(5, '합성 준비 중...');
                await new Promise(resolve => setTimeout(resolve, 500));

                for (let i = 0; i < baseImages.length; i++) {
                    const baseImage = baseImages[i];
                    const imageOrder = i + 1;
                    const progressPercentage = 10 + (i / baseImages.length) * 80;

                    updateProgress(progressPercentage, `${imageOrder}번째 이미지 합성 중... (${fileName}${imageOrder})`);

                    // 이미지 합성
                    const compositeImage = await createCompositeImage(
                        baseImage.dataUrl, 
                        savedLogo.dataUrl, 
                        logoPosition, 
                        logoSize
                    );

                    // 결과 저장
                    const result = {
                        image: compositeImage,
                        fileName: `${fileName}${imageOrder}`,
                        originalFileName: baseImage.fileName,
                        order: imageOrder,
                        createdAt: new Date().toISOString()
                    };

                    processedResults.push(result);
                    addResultToDisplay(result);

                    // 처리 간격
                    await new Promise(resolve => setTimeout(resolve, 300));
                }

                updateProgress(100, `모든 합성이 완료되었습니다! (총 ${baseImages.length}개)`);
                
                // 결과 섹션 표시
                const resultsSection = document.getElementById('resultsSection');
                const downloadAllBtn = document.getElementById('downloadAllBtn');
                const clearResultsBtn = document.getElementById('clearResultsBtn');
                const progressSection = document.getElementById('progressSection');
                
                if (resultsSection) resultsSection.style.display = 'block';
                if (downloadAllBtn) downloadAllBtn.style.display = 'block';
                if (clearResultsBtn) clearResultsBtn.style.display = 'block';
                updateResultCount();

                // 3초 후 진행바 숨기기
                setTimeout(() => {
                    if (progressSection) progressSection.style.display = 'none';
                }, 3000);

            } catch (error) {
                console.error('합성 중 오류 발생:', error);
                updateProgress(0, '합성 중 오류가 발생했습니다.');
                alert('합성 중 오류가 발생했습니다: ' + error.message);
            } finally {
                processBtn.disabled = false;
                processBtn.innerHTML = '✨ 로고 합성 시작';
            }
        };

        // 이미지 합성 (Canvas를 사용한 로고 오버레이)
        async function createCompositeImage(baseImageDataUrl, logoDataUrl, position, sizePercent) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                const baseImage = new Image();
                const logoImage = new Image();
                
                baseImage.onload = () => {
                    canvas.width = baseImage.width;
                    canvas.height = baseImage.height;
                    
                    // 베이스 이미지 그리기
                    ctx.drawImage(baseImage, 0, 0);
                    
                    logoImage.onload = () => {
                        // 로고 크기 조정
                        const logoSize = Math.min(canvas.width, canvas.height) * (sizePercent / 100);
                        const logoWidth = logoSize;
                        const logoHeight = (logoImage.height / logoImage.width) * logoSize;
                        
                        // 위치 계산
                        let x, y;
                        const margin = Math.min(canvas.width, canvas.height) * 0.02; // 2% 마진
                        
                        switch (position) {
                            case '좌측 상단':
                                x = margin;
                                y = margin;
                                break;
                            case '우측 상단':
                                x = canvas.width - logoWidth - margin;
                                y = margin;
                                break;
                            case '좌측 하단':
                                x = margin;
                                y = canvas.height - logoHeight - margin;
                                break;
                            case '우측 하단':
                                x = canvas.width - logoWidth - margin;
                                y = canvas.height - logoHeight - margin;
                                break;
                            case '중앙':
                            default:
                                x = (canvas.width - logoWidth) / 2;
                                y = (canvas.height - logoHeight) / 2;
                                break;
                        }
                        
                        // 그림자 효과
                        ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
                        ctx.shadowBlur = 8;
                        ctx.shadowOffsetX = 3;
                        ctx.shadowOffsetY = 3;
                        
                        // 로고 그리기
                        ctx.drawImage(logoImage, x, y, logoWidth, logoHeight);
                        
                        // 합성된 이미지 반환
                        resolve(canvas.toDataURL('image/jpeg', 0.92));
                    };
                    
                    logoImage.onerror = () => reject(new Error('로고 이미지 로드 실패'));
                    logoImage.src = logoDataUrl;
                };
                
                baseImage.onerror = () => reject(new Error('베이스 이미지 로드 실패'));
                baseImage.src = baseImageDataUrl;
            });
        }

        // 결과를 화면에 추가
        function addResultToDisplay(result) {
            const resultsGrid = document.getElementById('resultsGrid');
            if (!resultsGrid) return;
            
            const currentIndex = processedResults.length - 1;
            
            const resultDiv = document.createElement('div');
            resultDiv.className = 'result-item';
            resultDiv.setAttribute('data-result-index', currentIndex);
            resultDiv.innerHTML = `
                <img src="${result.image}" alt="${result.fileName}" onclick="openImageModal('${result.image}')">
                <div class="info">
                    <h3>${result.fileName}.jpg</h3>
                    <p>원본: ${result.originalFileName}</p>
                    <p>순서: ${result.order}번째</p>
                    <div class="action-buttons">
                        <button class="download-btn" onclick="downloadSingleResult(${currentIndex})">
                            💾 다운로드
                        </button>
                        <button class="delete-btn" onclick="deleteSingleResult(${currentIndex})">
                            🗑️ 삭제
                        </button>
                    </div>
                </div>
            `;
            
            resultsGrid.appendChild(resultDiv);
            updateResultCount();
            
            console.log(`✅ "${result.fileName}.jpg" 결과가 추가되었습니다. (인덱스: ${currentIndex})`);
            
            // 스크롤을 새로 추가된 결과로 이동
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // 개별 결과 삭제 (전역 함수로 변경)
        window.deleteSingleResult = function(index) {
            console.log('삭제 요청:', index, '전체 결과 수:', processedResults.length);
            
            if (index < 0 || index >= processedResults.length) {
                console.warn('잘못된 인덱스입니다:', index);
                alert('삭제할 항목을 찾을 수 없습니다.');
                return;
            }

            const result = processedResults[index];
            if (!result) {
                console.warn('삭제할 결과를 찾을 수 없습니다:', index);
                alert('삭제할 항목을 찾을 수 없습니다.');
                return;
            }

            if (confirm(`"${result.fileName}.jpg"을(를) 삭제하시겠습니까?`)) {
                // 배열에서 제거
                processedResults.splice(index, 1);
                
                // 전체 결과 화면을 다시 렌더링
                rerenderResults();
                
                console.log(`✅ "${result.fileName}.jpg"이(가) 삭제되었습니다.`);
                
                // 결과가 없으면 섹션 숨기기
                if (processedResults.length === 0) {
                    const resultsSection = document.getElementById('resultsSection');
                    const downloadAllBtn = document.getElementById('downloadAllBtn');
                    const clearResultsBtn = document.getElementById('clearResultsBtn');
                    
                    if (resultsSection) resultsSection.style.display = 'none';
                    if (downloadAllBtn) downloadAllBtn.style.display = 'none';
                    if (clearResultsBtn) clearResultsBtn.style.display = 'none';
                }
                
                updateResultCount();
            }
        };

        // 전체 결과 다시 렌더링
        function rerenderResults() {
            const resultsGrid = document.getElementById('resultsGrid');
            if (!resultsGrid) return;
            
            // 기존 결과 모두 제거
            resultsGrid.innerHTML = '';
            
            // 모든 결과를 다시 추가
            processedResults.forEach((result, index) => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'result-item';
                resultDiv.setAttribute('data-result-index', index);
                resultDiv.innerHTML = `
                    <img src="${result.image}" alt="${result.fileName}" onclick="openImageModal('${result.image}')">
                    <div class="info">
                        <h3>${result.fileName}.jpg</h3>
                        <p>원본: ${result.originalFileName}</p>
                        <p>순서: ${result.order}번째</p>
                        <div class="action-buttons">
                            <button class="download-btn" onclick="downloadSingleResult(${index})">
                                💾 다운로드
                            </button>
                            <button class="delete-btn" onclick="deleteSingleResult(${index})">
                                🗑️ 삭제
                            </button>
                        </div>
                    </div>
                `;
                resultsGrid.appendChild(resultDiv);
            });
        }

        // 전체 결과 삭제 (전역 함수로 변경)
        window.clearAllResults = function() {
            console.log('전체 삭제 요청, 현재 결과 수:', processedResults.length);
            
            if (processedResults.length === 0) {
                console.log('삭제할 결과가 없습니다.');
                alert('삭제할 결과가 없습니다.');
                return;
            }

            const resultCount = processedResults.length;
            if (confirm(`모든 합성 결과 ${resultCount}개를 삭제하시겠습니까?`)) {
                processedResults = [];
                
                const resultsGrid = document.getElementById('resultsGrid');
                const resultsSection = document.getElementById('resultsSection');
                const downloadAllBtn = document.getElementById('downloadAllBtn');
                const clearResultsBtn = document.getElementById('clearResultsBtn');
                
                if (resultsGrid) resultsGrid.innerHTML = '';
                if (resultsSection) resultsSection.style.display = 'none';
                if (downloadAllBtn) downloadAllBtn.style.display = 'none';
                if (clearResultsBtn) clearResultsBtn.style.display = 'none';
                
                updateResultCount();
                console.log(`✅ 모든 결과 ${resultCount}개가 삭제되었습니다.`);
            }
        };

        // 결과 개수 업데이트
        function updateResultCount() {
            const resultCount = document.getElementById('resultCount');
            if (resultCount) {
                resultCount.textContent = `${processedResults.length}개 결과`;
            }
        }

        // 개별 결과 다운로드 (전역 함수로 변경)
        window.downloadSingleResult = function(index) {
            console.log('다운로드 요청:', index, '전체 결과 수:', processedResults.length);
            
            if (index < 0 || index >= processedResults.length) {
                console.warn('잘못된 인덱스입니다:', index);
                alert('다운로드할 파일을 찾을 수 없습니다.');
                return;
            }

            const result = processedResults[index];
            if (!result) {
                console.warn('다운로드할 결과를 찾을 수 없습니다:', index);
                alert('다운로드할 파일을 찾을 수 없습니다.');
                return;
            }

            try {
                // Canvas를 사용해 이미지 다운로드
                const link = document.createElement('a');
                link.href = result.image;
                link.download = `${result.fileName}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log(`✅ "${result.fileName}.jpg"이(가) 다운로드되었습니다.`);
            } catch (error) {
                console.error('다운로드 중 오류 발생:', error);
                alert('다운로드 중 오류가 발생했습니다.');
            }
        };

        // 전체 결과 다운로드 (전역 함수로 변경)
        window.downloadAllResults = async function() {
            console.log('전체 다운로드 요청, 현재 결과 수:', processedResults.length);
            
            if (processedResults.length === 0) {
                console.log('다운로드할 결과가 없습니다.');
                alert('다운로드할 결과가 없습니다.');
                return;
            }

            const fileName = document.getElementById('fileName').value || '합성이미지';
            
            // ZIP 라이브러리가 없으므로 개별 다운로드
            if (confirm(`${processedResults.length}개의 이미지를 개별적으로 다운로드하시겠습니까?`)) {
                for (let i = 0; i < processedResults.length; i++) {
                    window.downloadSingleResult(i);
                    // 다운로드 간격
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                console.log(`✅ 모든 결과 ${processedResults.length}개가 다운로드되었습니다.`);
            }
        };

        // 이미지 모달 열기
        function openImageModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            
            modalImage.src = imageSrc;
            modal.style.display = 'block';
        }

        // 이미지 모달 닫기
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.style.display = 'none';
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', () => {
            loadSavedLogo();
            setupDragAndDrop();
            checkCanProcess();
            
            // ESC 키로 모달 닫기
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeImageModal();
                }
            });

            // 파일명 입력시 실시간 미리보기
            document.getElementById('fileName').addEventListener('input', (e) => {
                const value = e.target.value || '합성이미지';
                // 특수문자 제거
                e.target.value = value.replace(/[<>:"/\\|?*]/g, '');
            });

            // 로고 설정 변경시 미리보기 업데이트
            ['logoPosition', 'logoSize'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    // 설정이 변경되면 이전 결과 초기화
                    if (processedResults.length > 0) {
                        if (confirm('설정이 변경되었습니다. 이전 결과를 초기화하고 다시 합성하시겠습니까?')) {
                            processedResults = [];
                            document.getElementById('resultsGrid').innerHTML = '';
                            document.getElementById('resultsSection').style.display = 'none';
                            document.getElementById('downloadAllBtn').style.display = 'none';
                        }
                    }
                });
            });
        });

        // 브라우저 종료시 확인
        window.addEventListener('beforeunload', (e) => {
            if (processedResults.length > 0) {
                e.preventDefault();
                e.returnValue = '합성된 결과가 있습니다. 페이지를 떠나시겠습니까?';
            }
        });

        // 키보드 단축키
        document.addEventListener('keydown', (e) => {
            // Ctrl + O: 이미지 선택
            if (e.ctrlKey && e.key === 'o') {
                e.preventDefault();
                window.selectImages();
            }
            
            // Ctrl + Enter: 합성 시작
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                const processBtn = document.getElementById('processBtn');
                if (processBtn && !processBtn.disabled) {
                    window.processImages();
                }
            }
            
            // Ctrl + S: 전체 다운로드
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                if (processedResults.length > 0) {
                    window.downloadAllResults();
                }
            }
            
            // Ctrl + Delete: 결과 전체 삭제
            if (e.ctrlKey && e.key === 'Delete') {
                e.preventDefault();
                if (processedResults.length > 0) {
                    window.clearAllResults();
                }
            }
        });
    </script>
</body>
</html>
